---
name: Build and Push Container Images (Podman)

on:
  push:
    branches:
      - main
      - staging
      - develop
    paths:
      - backend/**
      - nginx-proxy/**
      - Dockerfile
      - frontend.Dockerfile.dev
      - package.json
      - bun.lock
  pull_request:
    branches:
      - main
      - staging
      - develop
    paths:
      - backend/**
      - nginx-proxy/**
      - Dockerfile
      - frontend.Dockerfile.dev
      - package.json
      - bun.lock
  workflow_run:
    workflows:
      - "INFRA_VERIFICATION"
    types:
      - completed
    branches:
      - develop
      - staging
      - main
  workflow_dispatch:
    inputs:
      build_all:
        description: Force rebuild of all images
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  id-token: write
  actions: read

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  ARTIFACT_REGISTRY_LOCATION: europe-west1
  ARTIFACT_REGISTRY_REPOSITORY: agentnav-containers

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    environment: >-
      ${{ github.ref == 'refs/heads/main' && 'production' ||
          github.ref == 'refs/heads/staging' && 'staging' ||
          'preview' }}
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_run'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine environment tags
        id: determine
        shell: bash
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV_TAG="production"
            LATEST_TAG="production"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENV_TAG="staging"
            LATEST_TAG="staging"
          else
            ENV_TAG="dev"
            LATEST_TAG="dev"
          fi

          REGISTRY="${ARTIFACT_REGISTRY_LOCATION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPOSITORY}"

          echo "environment_tag=${ENV_TAG}" >>"$GITHUB_OUTPUT"
          echo "latest_tag=${LATEST_TAG}" >>"$GITHUB_OUTPUT"
          echo "sha_tag=${GITHUB_SHA}" >>"$GITHUB_OUTPUT"
          echo "registry=${REGISTRY}" >>"$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud via Workload Identity Federation
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: access_token
          access_token_lifetime: 3600s

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman
          podman --version

      - name: Configure Podman for Artifact Registry
        run: |
          gcloud auth configure-docker \
            ${{ env.ARTIFACT_REGISTRY_LOCATION }}-docker.pkg.dev

      - name: Build and Push Backend Image
        working-directory: backend
        env:
          REGISTRY: ${{ steps.determine.outputs.registry }}
          ENV_TAG: ${{ steps.determine.outputs.environment_tag }}
          SHA_TAG: ${{ steps.determine.outputs.sha_tag }}
        run: |
          podman build \
            --tag "${REGISTRY}/agentnav-backend:${ENV_TAG}" \
            --tag "${REGISTRY}/agentnav-backend:${SHA_TAG}" \
            -f Dockerfile .

          podman push "${REGISTRY}/agentnav-backend:${ENV_TAG}"
          podman push "${REGISTRY}/agentnav-backend:${SHA_TAG}"

      - name: Build and Push Frontend Image
        env:
          REGISTRY: ${{ steps.determine.outputs.registry }}
          ENV_TAG: ${{ steps.determine.outputs.environment_tag }}
          SHA_TAG: ${{ steps.determine.outputs.sha_tag }}
        run: |
          podman build \
            --tag "${REGISTRY}/agentnav-frontend:${ENV_TAG}" \
            --tag "${REGISTRY}/agentnav-frontend:${SHA_TAG}" \
            -f Dockerfile .

          podman push "${REGISTRY}/agentnav-frontend:${ENV_TAG}"
          podman push "${REGISTRY}/agentnav-frontend:${SHA_TAG}"

      - name: Build and Push Proxy Image
        working-directory: nginx-proxy
        env:
          REGISTRY: ${{ steps.determine.outputs.registry }}
          ENV_TAG: ${{ steps.determine.outputs.environment_tag }}
          SHA_TAG: ${{ steps.determine.outputs.sha_tag }}
        run: |
          podman build \
            --tag "${REGISTRY}/agentnav-proxy:${ENV_TAG}" \
            --tag "${REGISTRY}/agentnav-proxy:${SHA_TAG}" \
            -f Dockerfile .

          podman push "${REGISTRY}/agentnav-proxy:${ENV_TAG}"
          podman push "${REGISTRY}/agentnav-proxy:${SHA_TAG}"

      - name: Build summary
        env:
          REGISTRY: ${{ steps.determine.outputs.registry }}
          ENV_TAG: ${{ steps.determine.outputs.environment_tag }}
          SHA_TAG: ${{ steps.determine.outputs.sha_tag }}
        run: |
          {
            echo "## ðŸ³ Container Build Complete"
            echo
            echo "**Registry:** ${REGISTRY}"
            echo "**Environment Tag:** ${ENV_TAG}"
            echo "**Images:**"
            echo "- \`agentnav-backend:${ENV_TAG}\` and \`agentnav-backend:${SHA_TAG}\`"
            echo "- \`agentnav-frontend:${ENV_TAG}\` and \`agentnav-frontend:${SHA_TAG}\`"
            echo "- \`agentnav-proxy:${ENV_TAG}\` and \`agentnav-proxy:${SHA_TAG}\`"
            echo
            echo "_Built with Podman and pushed to Artifact Registry_"
          } >>"$GITHUB_STEP_SUMMARY"
