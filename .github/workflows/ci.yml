name: CI - Tests & Security

on:
  pull_request:
    branches: [main]
  push:
    branches: ['**'] # Run on ALL branches for immediate feedback (FR#100)

jobs:
  # ============================================================================
  # PATH FILTERING DETECTION
  # ============================================================================

  changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      infra: ${{ steps.filter.outputs.infra }}
      docs: ${{ steps.filter.outputs.docs }}
      code: ${{ steps.filter.outputs.code }}
      dependencies: ${{ steps.filter.outputs.dependencies }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'components/**'
              - 'hooks/**'
              - 'services/*.ts'
              - 'services/*.tsx'
              - 'App.tsx'
              - 'index.tsx'
              - 'vite.config.ts'
              - 'tailwind.config.ts'
              - 'tsconfig.json'
              - 'package.json'
              - 'bun.lockb'
            backend:
              - 'backend/**'
              - 'pyproject.toml'
              - 'requirements*.txt'
            infra:
              - 'terraform/**'
            docs:
              - 'docs/**'
              - 'README.md'
              - 'LICENSE'
              - 'CODE_OF_CONDUCT.md'
              - 'CONTRIBUTING.md'
              - 'SECURITY.md'
              - 'NOTICE'
              - '*.md'
            code:
              - '**/*.ts'
              - '**/*.tsx'
              - '**/*.js'
              - '**/*.jsx'
              - '**/*.py'
              - '**/*.json'
              - '**/*.yml'
              - '**/*.yaml'
              - '**/*.md'
            dependencies:
              - 'package.json'
              - 'bun.lockb'
              - 'pyproject.toml'
              - 'requirements*.txt'

  # ============================================================================
  # MINIMUM REQUIRED CHECKS (Always Run)
  # ============================================================================

  code-quality:
    name: Code Quality (Linting & Formatting)
    runs-on: ubuntu-latest
    needs: changes
    # Always run on code/markdown changes (minimum required check)
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.code == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install frontend dependencies
        if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push'
        run: bun install

      - name: Run ESLint
        if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push'
        run: bun run lint

      - name: Check Prettier formatting
        if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push'
        run: bun run format:check

      - name: Setup Python
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dev dependencies
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        run: |
          python -m pip install --upgrade pip
          pip install black isort ruff mypy

      - name: Check Python formatting (Black)
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        run: black --check backend/

      - name: Check Python import sorting (isort)
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        run: isort --check-only --profile black backend/

      - name: Run Python linting (ruff)
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        run: ruff check backend/

      - name: Run Python type checking (mypy)
        if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
        run: mypy backend/ --ignore-missing-imports

  osv-scanner:
    name: OSV Dependency Vulnerability Scan
    needs: changes
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.dependencies == 'true'
    permissions:
      actions: read
      contents: read
      security-events: write
    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable.yml@v2.2.4
    with:
      scan-args: |-
        --recursive
        .

  # ============================================================================
  # PATH-FILTERED CI JOBS
  # ============================================================================

  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    # FRONTEND_CI: Trigger on frontend code or dependency changes
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: |
          bun install

      - name: Run frontend tests (Vitest)
        run: |
          bun run test -- --run

  backend-tests:
    name: Backend Tests (pytest + Firestore emulator)
    runs-on: ubuntu-latest
    needs: changes
    services: {}
    # BACKEND_CI: Trigger on backend code or dependency changes
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Firestore emulator (container)
        run: |
          docker run -d --name firestore-emulator -p 8081:8080 gcr.io/google.com/cloudsdktool/cloud-sdk:emulators \
            gcloud beta emulators firestore start --host-port=0.0.0.0:8080 --project=agentnav-dev
      - name: Wait for emulator
        run: |
          for i in {1..20}; do
            if nc -z localhost 8081; then
              echo "Firestore emulator is up"; break
            fi; sleep 1; done

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio google-cloud-firestore

      - name: Run backend tests
        env:
          FIRESTORE_EMULATOR_HOST: 'localhost:8081'
          FIRESTORE_PROJECT_ID: 'agentnav-dev'
          PYTHONPATH: ${{ github.workspace }}
        working-directory: backend
        run: |
          pytest -v

      - name: Run backend tests (Gemini model)
        env:
          FIRESTORE_EMULATOR_HOST: 'localhost:8081'
          FIRESTORE_PROJECT_ID: 'agentnav-dev'
          AGENTNAV_MODEL_TYPE: 'gemini'
        run: |
          pytest -q backend/tests/test_model_selection_integration.py

      - name: Run backend tests (Gemma model)
        env:
          FIRESTORE_EMULATOR_HOST: 'localhost:8081'
          FIRESTORE_PROJECT_ID: 'agentnav-dev'
          AGENTNAV_MODEL_TYPE: 'gemma'
        run: |
          pytest -q backend/tests/test_model_selection_integration.py

      - name: Stop Firestore emulator
        if: always()
        run: docker rm -f firestore-emulator || true

  tfsec-scan:
    name: Terraform Security Scan (tfsec)
    runs-on: ubuntu-latest
    needs: changes
    # INFRA_CI: Trigger only on Terraform changes
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.infra == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform
          soft_fail: true
          format: default

  secret-verification:
    name: Secret History Verification (FR#095)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for verification

      - name: Run secret verification script
        run: |
          chmod +x ./scripts/verify-no-secrets.sh
          ./scripts/verify-no-secrets.sh

      - name: Verify .gitignore contains .env pattern
        run: |
          if ! grep -q "^\.env$" .gitignore; then
            echo "ERROR: .env pattern not found in .gitignore"
            exit 1
          fi

      - name: Install detect-secrets
        run: |
          python3 -m pip install --upgrade "git+https://github.com/ibm/detect-secrets.git@master#egg=detect-secrets"

      - name: Scan for secrets with detect-secrets (non-interactive)
        run: |
          # Check if baseline exists
          if [ ! -f .secrets.baseline ]; then
            echo "âš ï¸  Baseline file not found. Please create it locally and commit:"
            echo "   detect-secrets scan --baseline .secrets.baseline"
            echo "   git add .secrets.baseline && git commit"
            exit 1
          fi
          
          # Scan current code and create temporary baseline
          echo "ðŸ” Scanning for secrets with detect-secrets..."
          detect-secrets scan --baseline /tmp/current-scan.baseline
          
          # Compare current scan with committed baseline
          # This will show differences if new secrets are found
          if ! detect-secrets compare /tmp/current-scan.baseline .secrets.baseline; then
            echo "âŒ New secrets detected! Differences found between current code and baseline."
            echo ""
            echo "To fix this locally:"
            echo "  1. Run: detect-secrets scan --update .secrets.baseline"
            echo "  2. Review the baseline file"
            echo "  3. Commit the updated baseline: git add .secrets.baseline && git commit"
            exit 1
          fi
          
          echo "âœ… No new secrets detected (baseline matches current scan)"
          echo "âœ“ .gitignore properly configured"

  # ============================================================================
  # COMPOSITE JOBS (Handle Skipped Jobs Gracefully)
  # ============================================================================
  CODE_QUALITY:
    name: CODE_QUALITY
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-tests, backend-tests]
    if: always()
    steps:
      - name: Aggregate Code Quality
        run: |
          echo "## ðŸ“Š CODE_QUALITY Aggregation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          CODE_QUALITY_RESULT="${{ needs.code-quality.result }}"
          FRONTEND_TESTS_RESULT="${{ needs.frontend-tests.result }}"
          BACKEND_TESTS_RESULT="${{ needs.backend-tests.result }}"
          
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| code-quality | $CODE_QUALITY_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| frontend-tests | $FRONTEND_TESTS_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| backend-tests | $BACKEND_TESTS_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for failure or cancelled states
          # success and skipped (from path filtering) are both acceptable
          if [[ "$CODE_QUALITY_RESULT" == "failure" ]] || [[ "$CODE_QUALITY_RESULT" == "cancelled" ]]; then
            echo "âŒ CODE_QUALITY check failed: code-quality job $CODE_QUALITY_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [[ "$FRONTEND_TESTS_RESULT" == "failure" ]] || [[ "$FRONTEND_TESTS_RESULT" == "cancelled" ]]; then
            echo "âŒ CODE_QUALITY check failed: frontend-tests job $FRONTEND_TESTS_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [[ "$BACKEND_TESTS_RESULT" == "failure" ]] || [[ "$BACKEND_TESTS_RESULT" == "cancelled" ]]; then
            echo "âŒ CODE_QUALITY check failed: backend-tests job $BACKEND_TESTS_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "âœ… CODE_QUALITY: All aggregated code quality jobs completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Skipped jobs (due to path filtering) are treated as passing." >> $GITHUB_STEP_SUMMARY

  SECURITY_AUDIT:
    name: SECURITY_AUDIT
    runs-on: ubuntu-latest
    needs: [tfsec-scan, osv-scanner, secret-verification]
    if: always()
    steps:
      - name: Aggregate Security Results
        run: |
          echo "## ðŸ”’ SECURITY_AUDIT Aggregation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TFSEC_RESULT="${{ needs.tfsec-scan.result }}"
          OSV_RESULT="${{ needs.osv-scanner.result }}"
          SECRET_VERIFICATION_RESULT="${{ needs.secret-verification.result }}"
          
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| tfsec-scan | $TFSEC_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| osv-scanner | $OSV_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| secret-verification | $SECRET_VERIFICATION_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for failure or cancelled states
          # success and skipped (from path filtering) are both acceptable
          if [[ "$TFSEC_RESULT" == "failure" ]] || [[ "$TFSEC_RESULT" == "cancelled" ]]; then
            echo "âŒ SECURITY_AUDIT check failed: tfsec-scan job $TFSEC_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [[ "$OSV_RESULT" == "failure" ]] || [[ "$OSV_RESULT" == "cancelled" ]]; then
            echo "âŒ SECURITY_AUDIT check failed: osv-scanner job $OSV_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          if [[ "$SECRET_VERIFICATION_RESULT" == "failure" ]] || [[ "$SECRET_VERIFICATION_RESULT" == "cancelled" ]]; then
            echo "âŒ SECURITY_AUDIT check failed: secret-verification job $SECRET_VERIFICATION_RESULT" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "âœ… SECURITY_AUDIT: All aggregated security jobs completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Skipped jobs (due to path filtering) are treated as passing." >> $GITHUB_STEP_SUMMARY

  # Final meta-check that runs unconditionally and handles skipped jobs properly
  # This is the ONLY check that should be required in branch protection rules
  AGENTIC_NAVIGATOR_QUALITY_GATE:
    name: AGENTIC_NAVIGATOR_QUALITY_GATE
    runs-on: ubuntu-latest
    needs: [CODE_QUALITY, SECURITY_AUDIT]
    if: always()
    steps:
      - name: Check Quality Gate Status
        run: |
          echo "## ðŸŽ¯ Agentic Navigator Quality Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Evaluating CI pipeline results..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CODE_QUALITY_RESULT="${{ needs.CODE_QUALITY.result }}"
          SECURITY_AUDIT_RESULT="${{ needs.SECURITY_AUDIT.result }}"

          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CODE_QUALITY | $CODE_QUALITY_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "| SECURITY_AUDIT | $SECURITY_AUDIT_RESULT |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # A job can be: success, failure, cancelled, or skipped
          # We pass if jobs are either success OR skipped (due to path filtering)
          # We fail only if a job that RAN has failed

          if [[ "$CODE_QUALITY_RESULT" == "failure" ]] || [[ "$SECURITY_AUDIT_RESULT" == "failure" ]]; then
            echo "âŒ Quality gate FAILED - One or more checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [[ "$CODE_QUALITY_RESULT" == "cancelled" ]] || [[ "$SECURITY_AUDIT_RESULT" == "cancelled" ]]; then
            echo "âš ï¸ Quality gate CANCELLED - One or more checks were cancelled" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Quality gate PASSED - All triggered checks succeeded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Note: Skipped checks (due to path filtering) are treated as passing." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
