---
name: "cleanup-cloud-run-services"

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: >-
          Type "DELETE ALL" to confirm deletion of Cloud Run services
        required: true
        type: string
      services:
        description: >-
          Optional comma-separated list of services to delete (default:
          auto-detect all)
        required: false
        default: 'auto'
        type: string
      regions:
        description: >-
          Optional comma-separated list of regions to scan (default:
          us-central1,europe-west1)
        required: false
        default: 'us-central1,europe-west1'
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  cleanup:
    name: Delete Cloud Run Services
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DELETE ALL" ]; then
            echo "âŒ Confirmation failed. You must type DELETE ALL to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: List Cloud Run services before deletion
        env:
          REGIONS_INPUT: ${{ github.event.inputs.regions }}
        run: |
          DEFAULT_REGIONS="us-central1,europe-west1"
          REGIONS=$(echo "${REGIONS_INPUT:-$DEFAULT_REGIONS}" | tr ',' ' ')
          SUMMARY="$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“‹ Current Cloud Run Services" >>"$SUMMARY"
          echo '```' >>"$SUMMARY"
          for region in $REGIONS; do
            echo "Region: $region" >>"$SUMMARY"
            if ! gcloud run services list \
              --region="$region" \
              --format="table(SERVICE,REGION,URL)" \
              2>/dev/null >>"$SUMMARY"; then
              echo "(no services)" >>"$SUMMARY"
            fi
            echo '' >>"$SUMMARY"
          done
          echo '```' >>"$SUMMARY"

      - name: Delete Cloud Run services
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SERVICES_INPUT: ${{ github.event.inputs.services }}
          REGIONS_INPUT: ${{ github.event.inputs.regions }}
        run: |
          DEFAULT_REGIONS="us-central1,europe-west1"
          REGIONS=$(echo "${REGIONS_INPUT:-$DEFAULT_REGIONS}" | tr ',' ' ')
          echo "REGIONS TO SCAN: $REGIONS"
          SUMMARY="$GITHUB_STEP_SUMMARY"

          if [ "$SERVICES_INPUT" = "auto" ]; then
            SERVICES_TO_DELETE=""
            for region in $REGIONS; do
              FOUND=$(gcloud run services list \
                --region="$region" \
                --format="value(metadata.name)" \
                2>/dev/null || true)
              if [ -n "$FOUND" ]; then
                # Build properly formatted list with newline separators
                FOUND_WITH_REGION=$(echo "$FOUND" | sed "s/$/,$region/")
                if [ -z "$SERVICES_TO_DELETE" ]; then
                  SERVICES_TO_DELETE="$FOUND_WITH_REGION"
                else
                  # Explicitly add newline between regions to prevent concatenation issues
                  SERVICES_TO_DELETE=$(printf '%s\n%s' "$SERVICES_TO_DELETE" "$FOUND_WITH_REGION")
                fi
              fi
            done
          else
            SERVICES_TO_DELETE=""
            for service in $(echo "$SERVICES_INPUT" | tr ',' ' '); do
              for region in $REGIONS; do
                SERVICE_ENTRY="$service,$region"
                if [ -z "$SERVICES_TO_DELETE" ]; then
                  SERVICES_TO_DELETE="$SERVICE_ENTRY"
                else
                  SERVICES_TO_DELETE=$(printf '%s\n%s' "$SERVICES_TO_DELETE" "$SERVICE_ENTRY")
                fi
              done
            done
          fi

          if [ -z "$SERVICES_TO_DELETE" ]; then
            echo "âœ… No Cloud Run services detected"
            echo "## âœ… No Services to Delete" >>"$SUMMARY"
            exit 0
          fi

          echo "## ðŸ—‘ï¸ Deleting Services" >>"$SUMMARY"
          echo '```' >>"$SUMMARY"

          DELETED_COUNT=0
          FAILED_COUNT=0

          while IFS=',' read -r service region; do
            # Trim whitespace from service and region
            service=$(echo "$service" | xargs)
            region=$(echo "$region" | xargs)
            
            if [ -n "$service" ] && [ -n "$region" ]; then
              echo "Deleting $service ($region)"
              if gcloud run services delete "$service" \
                --region="$region" \
                --project="$GCP_PROJECT_ID" \
                --quiet 2>&1; then
                echo "âœ… Deleted: $service ($region)" >>"$SUMMARY"
                DELETED_COUNT=$((DELETED_COUNT + 1))
              else
                echo "âŒ Failed: $service ($region)" >>"$SUMMARY"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            fi
          done < <(printf '%s\n' "$SERVICES_TO_DELETE")

          echo '```' >>"$SUMMARY"
          echo "" >>"$SUMMARY"
          printf '**Summary:** Deleted %s service(s), %s failure(s)\n' \
            "$DELETED_COUNT" "$FAILED_COUNT" >>"$SUMMARY"

          if [ "$FAILED_COUNT" -gt 0 ]; then
            exit 1
          fi

      - name: List Cloud Run services after deletion
        env:
          REGIONS_INPUT: ${{ github.event.inputs.regions }}
        run: |
          DEFAULT_REGIONS="us-central1,europe-west1"
          REGIONS=$(echo "${REGIONS_INPUT:-$DEFAULT_REGIONS}" | tr ',' ' ')
          SUMMARY="$GITHUB_STEP_SUMMARY"
          echo "## ðŸ“‹ Remaining Cloud Run Services" >>"$SUMMARY"
          echo '```' >>"$SUMMARY"
          for region in $REGIONS; do
            echo "Region: $region" >>"$SUMMARY"
            if ! gcloud run services list \
              --region="$region" \
              --format="table(SERVICE,REGION,URL)" \
              2>/dev/null >>"$SUMMARY"; then
              echo "(no services)" >>"$SUMMARY"
            fi
            echo '' >>"$SUMMARY"
          done
          echo '```' >>"$SUMMARY"
