name: Cloud Run Deploy

on:
  push:
    branches:
      - feature/us-central1-gar-prompt-vault
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: Optional image tag override (defaults to commit SHA)
        required: false
        type: string

env:
  GAR_REPOSITORY: agentnav-containers
  FRONTEND_REGION: us-central1
  BACKEND_REGION: europe-west1

permissions:
  contents: read
  id-token: write

jobs:
  deploy-backend:
    name: Deploy Backend
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@main
    with:
      environment: production
      service_name: agentnav-backend
      cloud_run_region: ${{ env.BACKEND_REGION }}
      gar_repository: ${{ env.GAR_REPOSITORY }}
      dockerfile: backend/Dockerfile
      build_context: backend
      container_port: "8080"
      allow_unauthenticated: true
      image_tag: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
      additional_env_vars: "ENVIRONMENT=production,ALLOWED_HOSTS=agentnav.lornu.com\\,*.run.app,CORS_ORIGINS=https://agentnav.lornu.com"
      additional_secrets: "GEMINI_API_KEY=GEMINI_API_KEY:latest"
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@main
    with:
      environment: production
      service_name: agentnav-frontend
      cloud_run_region: ${{ env.FRONTEND_REGION }}
      gar_repository: ${{ env.GAR_REPOSITORY }}
      dockerfile: Dockerfile
      build_context: .
      container_port: "80"
      allow_unauthenticated: true
      additional_env_vars: "PORT=80"
      image_tag: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
