name: Cloud Run Deploy (Prod)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: Optional image tag override (defaults to commit SHA)
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy-backend:
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@v0.2.0
    with:
      environment: production
      service_name: agentnav-backend
      cloud_run_region: europe-west1
      gar_repository: agentnav-containers
      dockerfile: backend/Dockerfile
      build_context: backend
      container_port: "8080"
      allow_unauthenticated: true
      image_tag: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
      additional_env_vars: "ENVIRONMENT=production,ALLOWED_HOSTS=agentnav.lornu.com\,*.run.app,CORS_ORIGINS=https://agentnav.lornu.com"
      additional_secrets: "GEMINI_API_KEY=GEMINI_API_KEY:latest"
    secrets: inherit

  deploy-frontend:
    needs: deploy-backend
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@v0.2.0
    with:
      environment: production
      service_name: agentnav-frontend
      cloud_run_region: us-central1
      gar_repository: agentnav-containers
      dockerfile: Dockerfile
      build_context: .
      container_port: "80"
      allow_unauthenticated: true
      additional_env_vars: "PORT=80"
      image_tag: ${{ inputs.image_tag != '' && inputs.image_tag || github.sha }}
    secrets: inherit
