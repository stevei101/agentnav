name: Manage DNS Configuration Secrets

on:
  workflow_dispatch:
    inputs:
      dns_zone_project_id:
        description: 'DNS Zone Project ID (where lornu.com DNS zone exists)'
        required: true
        type: string
      action:
        description: 'Action to perform'
        required: true
        default: 'create-or-update'
        type: choice
        options:
        - create-or-update
        - delete

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  manage-dns-secrets:
    name: Manage DNS Configuration Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create or Update DNS Zone Project ID Secret
        if: inputs.action == 'create-or-update'
        run: |
          echo "Creating/updating DNS Zone Project ID secret..."
          
          # Check if secret exists
          if gcloud secrets describe DNS_ZONE_PROJECT_ID --project=${{ env.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "Secret exists, adding new version..."
            echo -n "${{ inputs.dns_zone_project_id }}" | gcloud secrets versions add DNS_ZONE_PROJECT_ID \
              --data-file=- \
              --project=${{ env.GCP_PROJECT_ID }}
          else
            echo "Secret does not exist, creating..."
            echo -n "${{ inputs.dns_zone_project_id }}" | gcloud secrets create DNS_ZONE_PROJECT_ID \
              --data-file=- \
              --replication-policy=automatic \
              --labels=service=infrastructure,type=dns_config,managed_by=github_actions \
              --project=${{ env.GCP_PROJECT_ID }}
          fi
          
          echo "✅ DNS Zone Project ID secret configured successfully"

      - name: Delete DNS Zone Project ID Secret
        if: inputs.action == 'delete'
        run: |
          echo "Deleting DNS Zone Project ID secret..."
          gcloud secrets delete DNS_ZONE_PROJECT_ID \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet
          echo "✅ DNS Zone Project ID secret deleted successfully"

      - name: Verify Secret Access
        if: inputs.action == 'create-or-update'
        run: |
          echo "Verifying secret can be accessed..."
          SECRET_VALUE=$(gcloud secrets versions access latest \
            --secret=DNS_ZONE_PROJECT_ID \
            --project=${{ env.GCP_PROJECT_ID }})
          
          if [ "$SECRET_VALUE" = "${{ inputs.dns_zone_project_id }}" ]; then
            echo "✅ Secret verification successful"
          else
            echo "❌ Secret verification failed"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## DNS Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**DNS Zone Project ID:** ${{ inputs.dns_zone_project_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Project:** ${{ env.GCP_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.action }}" = "create-or-update" ]; then
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Run the Terraform workflow to deploy domain mapping" >> $GITHUB_STEP_SUMMARY
            echo "2. Extract DNS records from Terraform outputs" >> $GITHUB_STEP_SUMMARY
            echo "3. Create DNS records in infrastructure repository" >> $GITHUB_STEP_SUMMARY
          fi