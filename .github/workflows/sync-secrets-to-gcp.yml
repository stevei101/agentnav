name: Sync Secrets from GitHub to GCP Secret Manager

on:
  workflow_dispatch:
    inputs:
      secret_name:
        description: 'Secret name to sync (or "all" for all secrets)'
        required: true
        type: choice
        options:
          - all
          - HUGGINGFACE_TOKEN
          - GEMINI_API_KEY
          - FIRESTORE_CREDENTIALS
  push:
    branches:
      - main
    paths:
      - '.github/workflows/sync-secrets-to-gcp.yml'
  repository_dispatch:
    types: [sync-secrets]

# Only run on main branch or manual trigger
jobs:
  sync-secrets:
    name: Sync GitHub Secrets to GCP Secret Manager
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Sync HUGGINGFACE_TOKEN
        if: |
          github.event_name == 'workflow_dispatch' && 
          (github.event.inputs.secret_name == 'HUGGINGFACE_TOKEN' || github.event.inputs.secret_name == 'all') ||
          github.event_name == 'push' || 
          github.event_name == 'repository_dispatch'
        env:
          SECRET_VALUE: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          if [[ -z "$SECRET_VALUE" ]]; then
            echo "‚ö†Ô∏è  HUGGINGFACE_TOKEN not set in GitHub Secrets, skipping"
            exit 0
          fi
          
          echo "üîÑ Syncing HUGGINGFACE_TOKEN to GCP Secret Manager..."
          
          # Create secret if it doesn't exist (created by Terraform, but might not exist in some environments)
          if ! gcloud secrets describe HUGGINGFACE_TOKEN --project=${{ secrets.GCP_PROJECT_ID }} &>/dev/null; then
            echo "üìù Creating HUGGINGFACE_TOKEN secret..."
            gcloud secrets create HUGGINGFACE_TOKEN \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --replication-policy="automatic"
          fi
          
          # Add secret version
          echo -n "$SECRET_VALUE" | gcloud secrets versions add HUGGINGFACE_TOKEN \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --data-file=-
          
          echo "‚úÖ HUGGINGFACE_TOKEN synced successfully"

      - name: Sync GEMINI_API_KEY
        if: |
          github.event_name == 'workflow_dispatch' && 
          (github.event.inputs.secret_name == 'GEMINI_API_KEY' || github.event.inputs.secret_name == 'all') ||
          github.event_name == 'repository_dispatch'
        env:
          SECRET_VALUE: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [[ -z "$SECRET_VALUE" ]]; then
            echo "‚ö†Ô∏è  GEMINI_API_KEY not set in GitHub Secrets, skipping"
            exit 0
          fi
          
          echo "üîÑ Syncing GEMINI_API_KEY to GCP Secret Manager..."
          
          if ! gcloud secrets describe GEMINI_API_KEY --project=${{ secrets.GCP_PROJECT_ID }} &>/dev/null; then
            echo "üìù Creating GEMINI_API_KEY secret..."
            gcloud secrets create GEMINI_API_KEY \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --replication-policy="automatic"
          fi
          
          echo -n "$SECRET_VALUE" | gcloud secrets versions add GEMINI_API_KEY \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --data-file=-
          
          echo "‚úÖ GEMINI_API_KEY synced successfully"

      - name: Summary
        run: |
          echo "üìä Secret Sync Summary:"
          echo "  Project: ${{ secrets.GCP_PROJECT_ID }}"
          echo "  Triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "  Secret selected: ${{ github.event.inputs.secret_name }}"
          fi

