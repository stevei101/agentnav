name: Monitor Cloud Run IP Changes

on:
  schedule:
    # Run every day at 9 AM UTC to check for IP changes
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual runs

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  TF_CLOUD_ORGANIZATION: ${{ secrets.TF_CLOUD_ORGANIZATION }}
  TF_WORKSPACE: ${{ secrets.TF_WORKSPACE }}

jobs:
  check-ip-changes:
    name: Check Cloud Run IP Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      issues: write # To create GitHub issues if IPs change

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Check Current IPs
        id: check_ips
        working-directory: terraform
        run: |
          terraform init
          terraform refresh -input=false
          
          # Get current IPs
          CURRENT_IPS=$(terraform output -json current_cloud_run_ips)
          echo "current_ips=$CURRENT_IPS" >> $GITHUB_OUTPUT
          
          # Extract A records for easy comparison
          A_RECORDS=$(echo "$CURRENT_IPS" | jq -r '.a_records[]' | tr '\n' ',' | sed 's/,$//')
          echo "a_records=$A_RECORDS" >> $GITHUB_OUTPUT
          
          # Get DNS records for manual creation
          DNS_RECORDS=$(terraform output -json dns_records_for_manual_creation)
          echo "dns_records=$DNS_RECORDS" >> $GITHUB_OUTPUT

      - name: Compare with Previous IPs
        id: compare
        run: |
          # This is a simplified comparison - in practice you'd store previous IPs somewhere
          # For now, just output the current state for manual monitoring
          echo "## Current Cloud Run IP Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**A Records:** ${{ steps.check_ips.outputs.a_records }}" >> $GITHUB_STEP_SUMMARY
          echo "**Last Checked:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action Required:** If these IPs are different from your DNS records," >> $GITHUB_STEP_SUMMARY
          echo "update the infrastructure repository with the new DNS records:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check_ips.outputs.dns_records }}' | jq >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # Uncomment this if you want to automatically create GitHub issues for IP changes
      # - name: Create Issue for IP Change
      #   if: # Add condition to detect actual IP changes
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       github.rest.issues.create({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         title: 'Cloud Run IP Address Changed - Update DNS Records',
      #         body: `The Cloud Run IP addresses have changed and need to be updated in the infrastructure repository.\n\n**New DNS Records:**\n\`\`\`json\n${{ steps.check_ips.outputs.dns_records }}\n\`\`\``,
      #         labels: ['infrastructure', 'dns', 'urgent']
      #       })