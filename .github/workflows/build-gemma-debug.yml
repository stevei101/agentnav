name: Build Gemma Debug

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for running this debug build'
        required: false
        default: 'Manual debug build'
  push:
    branches:
      - main
    paths:
      - 'backend/Dockerfile.gemma*'
      - 'backend/gemma_service/**'

jobs:
  build-gemma-debug:
    name: Build Gemma (debug)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo layout and Dockerfile(s)
        run: |
          set -x
          echo "Repository root contents:"
          ls -la
          echo "\nbackend directory contents:"
          ls -la backend || true
          echo "\nShow backend/Dockerfile.gemma.ci (CI friendly):"
          sed -n '1,240p' backend/Dockerfile.gemma.ci || true
          echo "\nShow backend/Dockerfile.gemma (GPU production Dockerfile):"
          sed -n '1,240p' backend/Dockerfile.gemma || true

      - name: Build Gemma CI image - context ./backend
        run: |
          set -x
          docker version
          echo "Building CI-friendly image using backend/Dockerfile.gemma.ci"
          docker build --progress=plain --no-cache -f backend/Dockerfile.gemma.ci -t gemma-ci:pr-${{ github.event.number }} ./backend

      - name: Build Gemma production image - debug alternate
        if: failure()
        run: |
          set -x
          echo "Attempting to build production GPU image (backend/Dockerfile.gemma) with repo root as context"
          docker build --progress=plain --no-cache -f backend/Dockerfile.gemma -t gemma:pr-${{ github.event.number }} .

      - name: Finish
        if: success()
        run: echo "Gemma build completed (debug run)."
