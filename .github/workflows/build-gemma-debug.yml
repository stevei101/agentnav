name: Build Gemma Debug

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-gemma-debug:
    name: Build Gemma (debug)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repo layout and Dockerfile
        run: |
          set -x
          echo "Repository root contents:"
          ls -la
          echo "\nbackend directory contents:"
          ls -la backend || true
          echo "\nShow backend/Dockerfile.gemma (if present):"
          sed -n '1,240p' backend/Dockerfile.gemma || true

      - name: Build Gemma image (context: ./backend)
        run: |
          set -x
          docker version
          docker build --progress=plain --no-cache -f backend/Dockerfile.gemma -t gemma:pr-${{ github.event.number }} ./backend

      - name: Build Gemma image (context: repo root) (debug alternate)
        if: failure()
        run: |
          set -x
          docker build --progress=plain --no-cache -f backend/Dockerfile.gemma -t gemma:pr-${{ github.event.number }} .

      - name: Finish
        if: success()
        run: echo "Gemma build completed (debug run)."
