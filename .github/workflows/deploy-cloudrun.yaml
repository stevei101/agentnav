name: Deploy Agentnav to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-agentnav-${{ github.ref_name }}
  cancel-in-progress: true

env:
  GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY != '' && vars.GAR_REPOSITORY || 'agentnav-containers' }}
  DEPLOY_ENV: production
  TERRAFORM_DIR: terraform
  TERRAFORM_WORKSPACE: agentnav-production
  ALLOWED_HOSTS: ${{ vars.ALLOWED_HOSTS != '' && vars.ALLOWED_HOSTS || 'agentnav.lornu.com,*.run.app' }}
  CORS_ORIGINS: ${{ vars.CORS_ORIGINS != '' && vars.CORS_ORIGINS || 'https://agentnav.lornu.com' }}
  FIRESTORE_DATABASE_ID: ${{ vars.FIRESTORE_DATABASE_ID != '' && vars.FIRESTORE_DATABASE_ID || '(default)' }}

jobs:
  deploy-frontend:
    name: Deploy Frontend
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@v0.2.0
    with:
      environment: ${{ env.DEPLOY_ENV }}
      service_name: agentnav-frontend
      cloud_run_region: us-central1
      gar_repository: ${{ env.GAR_REPOSITORY }}
      dockerfile: Dockerfile
      build_context: .
      image_tag: ${{ github.sha }}
      container_port: "80"
      allow_unauthenticated: true
      additional_env_vars: ENVIRONMENT=${{ env.DEPLOY_ENV }}
      additional_secrets: ""
      terraform_directory: ${{ env.TERRAFORM_DIR }}
      terraform_workspace: ${{ env.TERRAFORM_WORKSPACE }}
      bun_install_dependencies: true
      bun_prebuild_commands: |
        bun run lint
        bun run type-check
        bun run test -- --run
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

  deploy-backend:
    name: Deploy Backend
    needs: deploy-frontend
    uses: stevei101/podman-cloudrun-deploy-gha/.github/workflows/podman-cloudrun-deploy.yaml@v0.2.0
    with:
      environment: ${{ env.DEPLOY_ENV }}
      service_name: agentnav-backend
      cloud_run_region: europe-west1
      gar_repository: ${{ env.GAR_REPOSITORY }}
      dockerfile: backend/Dockerfile
      build_context: backend
      image_tag: ${{ github.sha }}
      container_port: "8080"
      allow_unauthenticated: true
      additional_env_vars: ENVIRONMENT=${{ env.DEPLOY_ENV }},FIRESTORE_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }},FIRESTORE_DATABASE_ID=${{ env.FIRESTORE_DATABASE_ID }},A2A_PROTOCOL_ENABLED=true,ALLOWED_HOSTS=${{ env.ALLOWED_HOSTS }},CORS_ORIGINS=${{ env.CORS_ORIGINS }}
      additional_secrets: GEMINI_API_KEY=GEMINI_API_KEY:latest
      terraform_directory: ""
      terraform_workspace: ""
      bun_install_dependencies: false
      bun_prebuild_commands: ""
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      WIF_SERVICE_ACCOUNT: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
